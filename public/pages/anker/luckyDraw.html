<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="./main.css">
    <link rel="stylesheet" href="./lucky.css">
    <script src="./jquery.js"></script>
    <script src="./js/stuff.js"></script>
    <script src="./prize.js"></script>
    <script src="./lucky.js"></script>
</head>

<body>
    <div class="wrap">
        <div id="header">
            <a href="#lucky">马上抽奖</a>
            <a href="#show">海翼风采</a>
            <a href="#list">获奖名单</a>
            <a id="btnClear" href="" style="float:right">清 空</a>
        </div>
        <div id="banner">
            <p class="tc" id="prizeInfo">奖品图片为示例图，以最终到手的产品为准</p>
        </div>
        <a name="lucky" id="lucky"></a>
        <div id="imageWall" class="tc">
            <div class="bc" style="display:inline-block;">
                <div id="prizeScroll" class="tc">
                    <p class="f16 mb30">本轮奖品：<span id="prizeTitle"></span></p>
                    <ul class="inline mb20">
                        <li>
                            <span class="scrollWrap">
                                <span class="luckyItem">
                                    <img src="./img/prize/prizeDefault.png">
                                </span>
                            </span>
                        </li>
                    </ul>
                    
                    <button id="btnStart" type="button" class="btn btnDanger">开始抽奖</button>
                    <p class="mt20 pr50">抽奖规则：每人仅有一次抽奖机会，奖品均以发放到手的实物为准。</p>
                    <div id="scrollLeft"></div>
                    <div id="scrollBottom"></div>
                    <div id="scrollTopRight"></div>
                    <div id="scrollBottomRight"></div>
                </div>
                <div id="pirzeList">
                    <p class="pirzeListP">中奖名单</p>
                    <div id="pirzeListInner">
                        <ol>
                            
                        </ol>
                    </div>
                    <div id="currentPrizedPersons"></div>
                </div>
            </div>
        </div>
        
        <a name="show" id="show"></a>
        <div id="prizeShow">
            <form class="f20 lh200 mb20" style="color:#FF6527">WE ARE ANKERS
                <input type="text" id="txtSearch" placeholder="输入工号或者英文全名搜索 ..."/>
            </form>
            <table>
                <tr>
                    <td>
                        <div class="outerBorder">
                            <img src="">
                        </div>
                    </td>
                    <td>
                        <div class="outerBorder">
                            <img src="">
                        </div>
                    </td>
                    <td colspan="2">
                        <div class="outerBorder">
                            <img src="">
                        </div>
                    </td>
                    <td>
                        <div class="outerBorder">
                            <img src="">
                        </div>
                    </td>
                    <td>
                        <div class="outerBorder ">
                            <img src="">
                        </div>
                    </td>
                    <td>
                        <div class="outerBorder">
                            <img src="">
                        </div>
                    </td>
                    <td>
                        <div class="outerBorder ">
                            <img src="">
                        </div>
                    </td>
                    <td colspan="2" rowspan="2">
                        <div class="outerBorder">
                            <img src="" style="height: 297px">
                        </div>
                    </td>
                </tr>
                <tr>
                    <td colspan="2" rowspan="2">
                        <div class="outerBorder">
                            <img src="" style="height: 297px">
                        </div>
                    </td>
                    <td>
                        <div class="outerBorder">
                            <img src="">
                        </div>
                    </td>
                    <td colspan="2">
                        <div class="outerBorder">
                            <img src="">
                        </div>
                    </td>
                    <td colspan="2">
                        <div class="outerBorder">
                            <img src="">
                        </div>
                    </td>
                    <td>
                        <div class="outerBorder">
                            <img src="">
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="outerBorder">
                            <img src="">
                        </div>
                    </td>
                    <td colspan="2">
                        <div class="outerBorder">
                            <img src="">
                               
                        </div>
                    </td>
                    <td>
                        <div class="outerBorder">
                            <img src="">
                               
                        </div>
                    </td>
                    <td colspan="2">
                        <div class="outerBorder ">
                            <img src="">
                               
                        </div>
                    </td>
                    <td>
                        <div class="outerBorder">
                            <img src="">
                               
                        </div>
                    </td>
                    <td>
                        <div class="outerBorder">
                            <img src="">
                              
                        </div>
                    </td>
                </tr>
            </table>
        </div>

        <a name="list" id="list"></a>
        <div id="prizerDetail">
        <!-- <div id="prizeShow"> -->
            <p class="f20 lh200 mb20">获奖人信息</p>
            <table class="table tableStriped">
                <thead>
                    <tr>
                        <th>工号</th><th>中文名</th><th>全名</th><th>奖品</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="10" class="tc">暂无</td></tr>
                </tbody>
            </table>
        </div>
        <div id="foot">
            <p>Power by ERP</p>
        </div>
    </div>

    <div id="eleTipsNoPrize" class="tips">
        <div class="tipsInner">
            <img src="./img/oh.png" style="position:absolute;left: 0px; top:60px;">
            <div style="padding-left:230px; padding-top:80px;">
                <h3 class="f22">Oh, my god, 奖品已经抽完了~ </h3>
                <p class="f20 mt30" style="white-space: nowrap;">运气都留给别人，<span style="font-size:24px; color:#A92E39; font-weight: 700; ">酒都留给我 ！！！</span></p>
            </div>
        </div>
    </div>

    <div id="eleTipsInfo" class="tips">
        <div class="tipsInner">
            
        </div>
    </div>
    
    <script>

    var page = {
        eleScrollContainer: $('#prizeScroll'),
        elePrizeTitle: $('#prizeTitle'),
        eleScrollUl: $('#prizeScroll').find('ul'),
        elePrizedTable: $("#prizerDetail table tbody"),
        elePrizedList: $("#pirzeList ol"),
        eleTipsNoPrize: $('#eleTipsNoPrize'),
        eleTipsInfo: $('#eleTipsInfo'),
        eleCurrentPrizedPersons: $('#currentPrizedPersons'),

        currentPrize: null,  //当前轮奖品信息

        //获取默认头像
        getDefaultImg: function(person) {
            if(!person) {
                return './img/default.jpg';
            }
            var src = './js/img/' + person.number + '.jpg';
            var path = $.trim(person.path);
            if (!path || path == "NULL") {
                src = './img/default.jpg'
            }

            return src;
        },

        // 照片墙随机更替
        initStuffWall: function() {
            var imgs = $('#prizeShow table tbody img');
            var wallPersons = $.extend([], OCSTUFF);
            var length = wallPersons.length;

            var activePersons = []; 

            var getUniqueOne = function() {
                var seed;
                var randomOne = function() {
                    seed = Math.floor(Math.random() * length);
                    var one = wallPersons[seed];
                    return one;
                }

                var one = randomOne();
                while(!one.path || one.path == "NULL" || $.inArray(one.number, activePersons) !== -1 ) {
                    one = randomOne();
                }

                return one;
            }

            imgs.each(function() {
                var img = $(this);
                var one = getUniqueOne();

                activePersons.push(one.number);
                img.attr('src', page.getDefaultImg(one));
            })

            ;(function() {
                var callee = arguments.callee;
                var randomTime = 100 + Math.random() * 500;

                var imgCount = imgs.length;
                setTimeout(function() {
                    var seed = Math.floor(Math.random() * imgCount);
                    var targetImg = $(imgs[seed]);

                    var one = getUniqueOne();
                    targetImg.fadeOut(300, function() {
                        targetImg.attr('src', page.getDefaultImg(one));
                        targetImg.fadeIn();
                    })
                    
                    activePersons.splice(seed, 1, one.number);
                    callee();
                }, randomTime)
            })();
        },

        //初始化页面
        init: function(){
            this.initStuffWall();
            luckyDraw.init();
            this.setPrizedPerson();
            this.setPrize();

            if(!page.currentPrize) {
                page.tipsNoPrize();
            }

            $('#btnClear').on('click', function(e) {
                e.stopPropagation();
                e.preventDefault();
                var pwd = window.prompt("请输入密码");
                if(pwd === "oceanwing") {
                    var luckyString = window.localStorage.lucky;
                    window.localStorage["lucky_" + new Date().getTime()] = luckyString;
                    window.localStorage.lucky = "";
                    location.reload();
                }
            });

            var txtSearch = $('#txtSearch');
            txtSearch.parent().on('submit', function(e) {
                var text = txtSearch.val().toLowerCase();
                var finds = OCSTUFF.filter(function(model) {
                    return model.number == text || model.fullName.indexOf(text) !== -1;
                });

                var msg = '此人不在本次抽奖名单中';
                if(finds.length > 0) {
                    msg = finds.map(function(one) {
                        return one.cnName + ' - ' + one.fullName + ' - ' + one.number;
                    }).join('、');
                    msg = "查询结果：" + msg;
                }
                alert(msg);

                return false;
            });

            var btn = $("#btnStart");
            $("#btnStart").click(function() {
                if(!page.currentPrize){
                    page.tipsNoPrize();
                    return;
                }

                btn.attr('disabled', true);
                setTimeout(function(){
                    btn.removeAttr('disabled');
                }, 1200);
                var html = btn.html();
                if(html == '开始抽奖'){
                    page.startScroll();
                    btn.html('停止');
                }
                else if(html == '停止'){
                    page.stopScroll();
                    btn.html('下一轮');
                }
                else if(html == '下一轮'){
                    page.setPrize();
                    if(page.currentPrize){
                        btn.html('开始抽奖');
                    }
                }
            });

            $("#header").on('click', 'a', function(event) {
                var tag = $(this).attr('href');
                var a = $(tag);
                var top = a.offset().top;
                if(tag == "#lucky"){
                    top -= 50;
                }
                else{
                    top += 40;
                }
                $('html, body').animate({scrollTop: top}, 500);
                event.preventDefault();
            });

            $('.tips').on('click', function() {
                $(this).css({opacity: 0, top: '20%'}).hide();
            })
            .on('click', '.tipsInner', function(e) {
                e.stopPropagation();
            });
        },

        //设置下一轮奖品信息到页面上---
        setPrize: function(){
            page.eleCurrentPrizedPersons.removeClass('active');
            var len = luckyDraw.prizeList.length;
            var prizeInfo = getCurrentPrize(len);
            
            if(prizeInfo) {
                page.currentPrize = prizeInfo.prize;
                page.elePrizeTitle.html(page.currentPrize.name + ' (' + page.currentPrize.title + ')');
                var each = page.currentPrize.each || 1;
                if(each > prizeInfo.rest) {
                    each = prizeInfo.rest;
                }
                var firstScrollEle = page.eleScrollUl.find('li:eq(0)');
                firstScrollEle.nextAll('li').remove();
                for(var i = 0; i < each - 1; i ++) {
                    firstScrollEle.clone().appendTo(page.eleScrollUl);
                }
                
                page.eleScrollUl.find('li img').addClass('imgPrice').attr('src', './img/prize/' + page.currentPrize.src);
                page.eleScrollUl.find('.prizeName').remove();
            }
            else {
                page.tipsNoPrize();
            }
        },

        //开始滚动头像----
        startScroll: function(){
            page.eleScrollUl.find('.luckyItem').each(function() {
                page.scroll($(this), 100);
            })
        },

        scroll: function(ele, speed) {
            var eleTimer = setInterval(function(){
                var stuff = luckyDraw.restPerson;
                var len = stuff.length;
                var seed = Math.random();
                var index = Math.floor(seed * len);
                var model = stuff[index];
                var src = page.getDefaultImg(model);
                var img = ele.find('img').removeClass('imgPrice')
                var tmpImg = img.clone().attr('src', src).appendTo(ele);
                ele.animate({
                    'top': '-200px'
                }, speed - 20, function() {
                    img.remove();
                    ele.css('top', 0);
                });

            }, speed);

            ele.data('timer', eleTimer);
        },

        stopScroll: function(){
            var scrollItem = page.eleScrollUl.find('.luckyItem')
            var luckyPerson = luckyDraw.getLucky(scrollItem.length, page.currentPrize);
            scrollItem.each(function(i, ele) {
                ele = $(ele);
                var timer = ele.data('timer');
                if(!timer){
                    return false;
                }
                clearInterval(timer);

                var model = luckyPerson[i];

                var src = page.getDefaultImg(model);

                ele.find('img').attr('src', src);
                var li = ele.parents('li:first');
                li.find('.prizeName').remove();
                li.append('<p class="prizeName">' + model.cnName + '<br>(' + model.fullName + ')</p>');
            });

            page.setPrizedPerson(luckyPerson);
        },

        //设置中奖名单--
        setPrizedPerson: function(currentPrizeds){
            var len = luckyDraw.prizeList.length;
            if(!len){
                return;
            }
            var tbody = page.elePrizedTable.html('');
            var ol = page.elePrizedList.html('');
            for(var i = 0; i < len; i++){
                var person = luckyDraw.prizeList[i];
                var tr = '<tr><td>' + person.number + '</td><td>' + person.cnName + '</td><td>' + person.fullName + '</td><td>' + person.prizeName + '</td></tr>';

                tbody.append(tr);
                ol.append('<li>' + person.cnName + ' (' + person.fullName + ') --- ' + person.prizeName + '</li>');
                if(ol.height() > 350){
                    ol.css({top: 'auto', bottom: '0'});
                }
            }

            if(currentPrizeds) {
                var eleCurr = $('#currentPrizedPersons').html('').addClass('active');
                currentPrizeds.map(function(one) {
                    eleCurr.append('<p>' + one.cnName + ' - ' + one.fullName + ' - ' + one.number + '</p>');
                });
            }
            else {
                $('#currentPrizedPersons').html('').removeClass('active');
            }
        },

        tipsNoPrize: function() {
            if(page.eleTipsNoPrize.is(':visible')){
                return;
            }

            page.eleTipsNoPrize.show().animate({top: '50%', opacity: 1}, 200);
        },

        tips: function(msg) {
            if(!msg) {
                return;
            }

            page.eleTipsInfo.css({opacity: 0, top: '20%'}).hide();
            page.eleTipsInfo.find('.tipsInner').html(msg);
            page.eleTipsInfo.show().animate({top: '50%', opacity: 1}, 200);
        }
    }

    page.init();
    
    var noImgs = [];
    OCSTUFF.map(function(one) {
        if(!one.path || one.path == "NULL") {
            noImgs.push(one.fullName);
        }
    })
    console.log('系统中没有头像的人：' + noImgs.join('\n'));
    </script>
</body>

</html>
